<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Journal PWA - Study Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .timer-card {
            background: var(--nav-bg);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
        }
        #timer-display {
            font-size: 5rem;
            font-weight: 800;
            font-family: monospace;
            color: var(--primary-color);
            margin: 0.5rem 0;
        }
        /* Progress Bar Styling */
        .progress-container {
            width: 100%;
            background-color: #444;
            border-radius: 10px;
            height: 12px;
            margin: 1rem 0 2rem 0;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            transition: width 1s linear;
        }
        .timer-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            font-size: 1rem;
        }
        #start-btn { background: #2ecc71; color: white; }
        #pause-btn { background: #f1c40f; color: white; display: none; }
        #reset-btn { background: #e74c3c; color: white; }

        .log-section {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid #ddd;
            color: var(--text-color);
        }
        .dark-mode .log-section { background: #2a2a2a; border-color: #444; }
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>
    <button id="theme-toggle">Switch to Dark Mode</button>

    <main>
        <h1>Study Tracker</h1>
        <p>Your session persists even if you navigate to other pages.</p>

        <section class="timer-card">
            <h2 id="timer-status">Focus Session</h2>

            <div id="timer-display">25:00</div>

            <div class="progress-container">
                <div id="progress-bar"></div>
            </div>

            <div class="timer-controls">
                <button id="start-btn" class="timer-btn">Start Session</button>
                <button id="pause-btn" class="timer-btn">Stop/Reset</button>
                <button id="reset-btn" class="timer-btn">Clear Timer</button>
            </div>
        </section>

        <section class="log-section">
            <h3>Recent Successes</h3>
            <ul id="study-history"></ul>
            <button id="clear-history" style="margin-top:15px; color:var(--primary-color); background:none; border:none; cursor:pointer; font-weight:bold;">üóëÔ∏è Clear History</button>
        </section>

        <section style="margin-top: 2rem;">
            <h3>Study Vibe</h3>
            <iframe style="border-radius:12px" src="http://googleusercontent.com/spotify.com/3" width="100%" height="152" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
        </section>
    </main>

    <footer>
        <p>¬© 2025 Ramesh Chaudhary. All rights reserved.</p>
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/storage.js') }}"></script>
    <script src="{{ url_for('static', filename='js/browser.js') }}"></script>
    <script>
        const TOTAL_TIME = 25 * 60; // 25 Minutes in seconds
        const TIMER_KEY = 'pwa_study_timer_end'; // End timestamp key
        const HISTORY_KEY = 'studySessions';

        let timerId = null;

        const display = document.getElementById('timer-display');
        const progressBar = document.getElementById('progress-bar');
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');

        // --- Core Functions ---

        function updateUI(secondsRemaining) {
            // Calculate time
            const mins = Math.floor(Math.max(0, secondsRemaining) / 60);
            const secs = Math.max(0, secondsRemaining) % 60;
            display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // Calculate progress: $$ \text{percent} = \left( 1 - \frac{\text{remaining}}{\text{total}} \right) \times 100 $$
            const percent = ((TOTAL_TIME - secondsRemaining) / TOTAL_TIME) * 100;
            progressBar.style.width = `${Math.min(100, percent)}%`;
        }

        function checkExistingTimer() {
            const endTime = localStorage.getItem(TIMER_KEY);
            if (endTime) {
                const now = Date.now();
                const remaining = Math.floor((parseInt(endTime) - now) / 1000);

                if (remaining > 0) {
                    runTimer(remaining);
                } else {
                    localStorage.removeItem(TIMER_KEY);
                    updateUI(TOTAL_TIME);
                }
            } else {
                updateUI(TOTAL_TIME);
            }
        }

        function runTimer(seconds) {
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';

            timerId = setInterval(() => {
                const endTime = parseInt(localStorage.getItem(TIMER_KEY));
                const now = Date.now();
                const remaining = Math.floor((endTime - now) / 1000);

                if (remaining <= 0) {
                    clearInterval(timerId);
                    completeSession();
                } else {
                    updateUI(remaining);
                }
            }, 1000);
        }

        function completeSession() {
            saveHistory();
            alert("Great work! Session complete.");
            localStorage.removeItem(TIMER_KEY);
            resetInterface();
        }

        function resetInterface() {
            clearInterval(timerId);
            timerId = null;
            updateUI(TOTAL_TIME);
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
        }

        // --- Event Handlers ---

        startBtn.onclick = () => {
            const endTimestamp = Date.now() + (TOTAL_TIME * 1000);
            localStorage.setItem(TIMER_KEY, endTimestamp);
            runTimer(TOTAL_TIME);
        };

        pauseBtn.onclick = () => {
            if(confirm("Stop this session and reset the timer?")) {
                localStorage.removeItem(TIMER_KEY);
                resetInterface();
            }
        };

        document.getElementById('reset-btn').onclick = () => {
            localStorage.removeItem(TIMER_KEY);
            resetInterface();
        };

        // --- History Management ---

        function saveHistory() {
            const sessions = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            sessions.unshift({
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(sessions.slice(0, 5)));
            renderHistory();
        }

        function renderHistory() {
            const sessions = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
            const list = document.getElementById('study-history');
            list.innerHTML = sessions.length
                ? sessions.map(s => `<li class="history-item"><span>üìÖ ${s.date}</span><span>‚è±Ô∏è 25m at ${s.time}</span></li>`).join('')
                : '<li class="history-item">Complete a session to see it here!</li>';
        }

        document.getElementById('clear-history').onclick = () => {
            localStorage.removeItem(HISTORY_KEY);
            renderHistory();
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            checkExistingTimer();
            renderHistory();
        });
    </script>
</body>
</html>
